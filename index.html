<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Portefeuille</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  :root, [data-theme="dark"] {
    --bg: #0f1117; --card: #1a1d2e; --border: #2a2d3e;
    --accent: #6c5ce7; --accent2: #00cec9; --green: #00b894;
    --red: #ff7675; --text: #dfe6e9; --text2: #a0a4b8;
    --gold: #fdcb6e; --orange: #e17055; --yellow: #ffeaa7;
    --shadow: rgba(0,0,0,.3);
  }
  [data-theme="light"] {
    --bg: #f0f2f5; --card: #ffffff; --border: #e0e3ea;
    --accent: #6c5ce7; --accent2: #00a89e; --green: #00a884;
    --red: #e74c3c; --text: #1a1d2e; --text2: #6b7280;
    --gold: #d4a017; --orange: #d35400; --yellow: #f39c12;
    --shadow: rgba(0,0,0,.08);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; padding:0; overflow-x:hidden; }
  .container { max-width:960px; margin:0 auto; padding:16px; }
  .app-header { text-align:center; margin-bottom:20px; }
  .app-header .logo { font-size:2.6rem; margin-bottom:2px; display:flex; justify-content:center; }
  .app-header h1 { font-size:1.6rem; background:linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:4px; }
  .app-header .tagline { color:var(--text2); font-size:.88rem; }
  .section-title { display:flex; align-items:center; gap:10px; font-size:1.15rem; font-weight:700; margin-bottom:14px; }
  .section-title .icon { font-size:1.4rem; }

  /* LOCK SCREEN */
  .lock-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:300; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; }
  .lock-screen.hidden { display:none; }
  .lock-screen .lock-icon { font-size:4rem; margin-bottom:8px; }
  .lock-screen h2 { font-size:1.4rem; color:var(--text); margin-bottom:4px; }
  .lock-screen p { color:var(--text2); font-size:.9rem; margin-bottom:16px; }
  .lock-screen input { background:var(--card); border:2px solid var(--border); color:var(--text); padding:16px 20px; border-radius:14px; font-size:1.4rem; width:200px; text-align:center; outline:none; letter-spacing:8px; }
  .lock-screen input:focus { border-color:var(--accent); }
  .lock-error { color:var(--red); font-size:.85rem; min-height:22px; }

  /* TABS */
  .tabs { display:flex; background:var(--card); border-radius:14px; padding:4px; margin-bottom:24px; border:1px solid var(--border); position:sticky; top:0; z-index:30; }
  .tab { flex:1; text-align:center; padding:14px 10px; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer; transition:all .2s; color:var(--text2); display:flex; align-items:center; justify-content:center; gap:8px; }
  .tab.active { background:linear-gradient(135deg,var(--accent),#7c6cf0); color:#fff; }
  .tab:not(.active):hover { background:rgba(255,255,255,.04); }
  .tab-content { display:none; }
  .tab-content.active { display:block; }

  /* Stats */
  .stats { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:24px; }
  @media(min-width:600px){ .stats { grid-template-columns:repeat(4,1fr); } }
  .stat-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px 12px; text-align:center; }
  .stat-card .emoji { font-size:1.6rem; margin-bottom:4px; }
  .stat-card .label { font-size:.75rem; color:var(--text2); margin-bottom:4px; }
  .stat-card .value { font-size:1.25rem; font-weight:700; }
  .stat-card .value.green { color:var(--green); }
  .stat-card .value.accent { color:var(--accent); }
  .stat-card .value.gold { color:var(--gold); }
  .stat-card .value.accent2 { color:var(--accent2); }
  .stat-card.big { grid-column:1/-1; padding:20px; }
  .stat-card.big .emoji { font-size:2rem; }
  .stat-card.big .value { font-size:1.8rem; }
  .earnings-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px; margin-bottom:24px; }
  .earnings-card { background:linear-gradient(135deg, var(--card) 0%, rgba(0,184,148,.08) 100%); border-color:rgba(0,184,148,.25); position:relative; overflow:hidden; }
  .earnings-card .value { font-size:1.35rem; }
  .earnings-sub { font-size:.7rem; color:var(--text2); margin-top:4px; font-style:italic; }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 0 0 rgba(0,184,148,.15);} 50%{box-shadow:0 0 12px 4px rgba(0,184,148,.2);} }
  .earnings-card.active { animation:pulse-green 2s ease-in-out infinite; }

  /* Cards */
  .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:20px; }
  .card.pending { border-color:rgba(255,234,167,.3); }
  .card.pending .section-title { color:var(--yellow); }
  .pending-count { display:inline-flex; align-items:center; justify-content:center; background:var(--yellow); color:var(--bg); font-size:.75rem; font-weight:700; width:22px; height:22px; border-radius:50%; }

  /* Form */
  .form-row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
  .form-group { display:flex; flex-direction:column; flex:1; min-width:130px; }
  .form-group label { font-size:.82rem; color:var(--text2); margin-bottom:5px; display:flex; align-items:center; gap:5px; }
  .form-group input, .form-group select { background:var(--bg); border:1px solid var(--border); color:var(--text); padding:12px 14px; border-radius:10px; font-size:1rem; outline:none; transition:border-color .2s; }
  .form-group input:focus, .form-group select:focus { border-color:var(--accent); }
  .form-group select option { background:var(--bg); color:var(--text); }
  .form-hint { font-size:.82rem; color:var(--text2); margin-bottom:14px; line-height:1.5; }

  /* Buttons */
  .btn { border:none; padding:12px 24px; border-radius:10px; font-size:1rem; cursor:pointer; font-weight:600; transition:transform .1s,opacity .15s; white-space:nowrap; display:inline-flex; align-items:center; gap:8px; }
  .btn:hover { opacity:.92; }
  .btn:active { transform:scale(.97); }
  .btn-primary { background:linear-gradient(135deg,var(--accent),#7c6cf0); color:#fff; }
  .btn-green { background:linear-gradient(135deg,var(--green),#55efc4); color:#fff; }
  .btn-red { background:linear-gradient(135deg,var(--red),var(--orange)); color:#fff; }
  .btn-sm { padding:8px 16px; font-size:.88rem; border-radius:8px; }
  .btn-ghost { background:var(--border); color:var(--text2); padding:7px 14px; border-radius:8px; font-size:.8rem; border:none; cursor:pointer; transition:background .2s; }
  .btn-ghost:hover { background:#3a3d5e; color:var(--text); }
  .btn-ghost.danger { color:var(--red); }
  .btn-ghost.danger:hover { background:rgba(255,118,117,.15); }
  .btn-delete { background:rgba(255,118,117,.15); color:var(--red); border:none; padding:6px 12px; border-radius:8px; font-size:.85rem; cursor:pointer; }
  .btn-delete:hover { background:rgba(255,118,117,.25); }
  .btn-edit { background:rgba(108,92,231,.15); color:var(--accent); border:none; padding:6px 12px; border-radius:8px; font-size:.85rem; cursor:pointer; }
  .btn-edit:hover { background:rgba(108,92,231,.25); }
  .btn-pm { background:var(--card); border:1px solid var(--border); color:var(--accent); width:40px; height:42px; border-radius:10px; font-size:1.3rem; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:border-color .2s,background .2s; }
  .btn-pm:hover { border-color:var(--accent); background:rgba(108,92,231,.15); }
  .chart-wrapper { position:relative; height:280px; }

  /* Table */
  table { width:100%; border-collapse:collapse; }
  th { text-align:left; font-size:.72rem; color:var(--text2); text-transform:uppercase; letter-spacing:.5px; padding:10px; border-bottom:1px solid var(--border); }
  td { padding:10px; border-bottom:1px solid var(--border); font-size:.9rem; vertical-align:middle; }
  tr:last-child td { border-bottom:none; }
  .plus-value { color:var(--green); font-weight:600; }
  .retrait-value { color:var(--orange); font-weight:600; }
  .type-badge { display:inline-block; padding:3px 10px; border-radius:6px; font-size:.78rem; font-weight:600; }
  .type-invest { background:rgba(108,92,231,.2); color:var(--accent); }
  .type-retrait { background:rgba(225,112,85,.2); color:var(--orange); }
  .duration-info { color:var(--text2); font-size:.8rem; }
  .empty-state { text-align:center; color:var(--text2); padding:40px 20px; font-size:.95rem; }
  .empty-state .empty-icon { font-size:2.5rem; margin-bottom:10px; }

  .admin-bar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
  .admin-bar-right { display:flex; gap:8px; flex-wrap:wrap; }
  .sep { border:none; border-top:2px solid var(--border); margin:36px 0 28px; }
  .footer { text-align:center; color:var(--text2); font-size:.75rem; margin-top:24px; padding:12px; border-top:1px solid var(--border); }

  /* Asset card */
  .asset-item { display:flex; align-items:center; gap:14px; padding:14px; background:var(--bg); border-radius:12px; margin-bottom:10px; }
  .asset-icon { font-size:1.8rem; width:44px; text-align:center; }
  .asset-info { flex:1; }
  .asset-name { font-weight:600; font-size:.95rem; margin-bottom:2px; }
  .asset-date { font-size:.75rem; color:var(--text2); }
  .asset-value { font-size:1.15rem; font-weight:700; color:var(--accent2); margin-right:8px; }
  .asset-actions { display:flex; gap:6px; }
  .asset-history { margin:0 0 10px 58px; padding:8px 12px; background:rgba(255,255,255,.03); border-radius:10px; border:1px solid var(--border); }
  .asset-history-title { font-size:.78rem; color:var(--text2); margin-bottom:6px; cursor:pointer; display:flex; align-items:center; gap:6px; }
  .asset-history-title:hover { color:var(--text); }
  .history-entry { display:flex; align-items:center; justify-content:space-between; padding:4px 0; font-size:.82rem; border-bottom:1px solid rgba(255,255,255,.04); }
  .history-entry:last-child { border-bottom:none; }
  .history-entry .he-date { color:var(--text2); }
  .history-entry .he-value { color:var(--accent2); font-weight:600; }
  .history-entry .he-del { background:none; border:none; color:var(--red); cursor:pointer; font-size:.75rem; opacity:.5; padding:2px 6px; }
  .history-entry .he-del:hover { opacity:1; }

  /* Modal */
  .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.75); z-index:100; justify-content:center; align-items:center; }
  .modal-overlay.active { display:flex; }
  .modal { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:32px; width:90%; max-width:400px; text-align:center; }
  .modal .modal-icon { font-size:2.5rem; margin-bottom:8px; }
  .modal h3 { margin-bottom:6px; font-size:1.2rem; }
  .modal p { color:var(--text2); font-size:.9rem; margin-bottom:20px; line-height:1.4; }
  .modal input, .modal select { background:var(--bg); border:1px solid var(--border); color:var(--text); padding:14px 16px; border-radius:10px; font-size:1.1rem; width:100%; outline:none; margin-bottom:12px; }
  .modal input:focus, .modal select:focus { border-color:var(--accent); }
  .modal-btns { display:flex; gap:10px; justify-content:center; }
  .modal-btns .btn { flex:1; }
  .modal-error { color:var(--red); font-size:.85rem; margin-bottom:10px; min-height:20px; }

  /* Loading */
  .loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:200; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; }
  .loading-overlay.hidden { display:none; }
  .loading-spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--accent2); border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .toggle-switch { position:relative; display:inline-block; width:46px; height:26px; cursor:pointer; }
  .toggle-switch input { opacity:0; width:0; height:0; }
  .toggle-slider { position:absolute; top:0; left:0; right:0; bottom:0; background:var(--border); border-radius:26px; transition:.3s; }
  .toggle-slider:before { content:''; position:absolute; height:20px; width:20px; left:3px; bottom:3px; background:var(--text2); border-radius:50%; transition:.3s; }
  .toggle-switch input:checked + .toggle-slider { background:var(--green); }
  .toggle-switch input:checked + .toggle-slider:before { transform:translateX(20px); background:#fff; }
  .pw-wrap { position:relative; width:100%; margin-bottom:12px; }
  .pw-wrap input { width:100%; padding-right:44px; }
  .pw-eye { position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; font-size:1.1rem; opacity:.5; transition:opacity .2s; padding:4px 6px; }
  .pw-eye:hover { opacity:1; }
  .pw-eye.showing { opacity:1; }
  .lock-btn { width:42px; height:42px; border-radius:50%; border:1px solid var(--border); background:var(--card); cursor:pointer; font-size:1.2rem; display:flex; align-items:center; justify-content:center; transition:all .3s; box-shadow:0 2px 8px var(--shadow); }
  .lock-btn:hover { transform:scale(1.1); border-color:var(--accent); }
  .theme-toggle { width:42px; height:42px; border-radius:50%; border:1px solid var(--border); background:var(--card); cursor:pointer; font-size:1.2rem; display:flex; align-items:center; justify-content:center; transition:all .3s; box-shadow:0 2px 8px var(--shadow); }
  .theme-toggle:hover { transform:scale(1.1); border-color:var(--accent); }
  .top-bar { display:flex; justify-content:space-between; align-items:center; padding:10px 16px; }
  [data-theme="light"] .stat-card { box-shadow:0 2px 8px var(--shadow); }
  [data-theme="light"] .card { box-shadow:0 2px 8px var(--shadow); }
  [data-theme="light"] .tabs { box-shadow:0 2px 8px var(--shadow); }
  [data-theme="light"] .form-group input, [data-theme="light"] .form-group select { background:#f8f9fb; }
  [data-theme="light"] .modal input, [data-theme="light"] .modal select { background:#f8f9fb; }
  [data-theme="light"] .asset-item { background:#f8f9fb; }
  [data-theme="light"] .tab:not(.active):hover { background:rgba(0,0,0,.04); }
  [data-theme="light"] .btn-ghost { background:#e8eaef; color:var(--text2); }
  [data-theme="light"] .btn-ghost:hover { background:#d8dae0; }
  [data-theme="light"] .loading-overlay { background:var(--bg); }
  [data-theme="light"] .lock-screen { background:var(--bg); }

  @media(max-width:500px){
    .container { padding:10px; }
    .form-row { flex-direction:column; }
    .form-group { min-width:100%; }
    .btn { width:100%; justify-content:center; }
    .admin-bar { flex-direction:column; align-items:stretch; }
    .admin-bar-right { justify-content:center; }
    .tabs { border-radius:10px; }
    .tab { padding:10px 6px; font-size:.85rem; gap:4px; }
    .earnings-row { grid-template-columns:1fr; }
    .earnings-card .value { font-size:1.15rem; }
    .stat-card .value { font-size:1.05rem; }
    .stat-card .emoji { font-size:1.3rem; }
    .stat-card { padding:12px 8px; }
    .card { padding:14px; }
    .asset-item { flex-wrap:wrap; gap:10px; padding:12px; }
    .asset-value { font-size:1rem; }
    .asset-actions { gap:4px; }
    .modal { padding:24px 18px; }
    .app-header h1 { font-size:1.3rem; }
    table { display:block; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    th, td { white-space:nowrap; padding:8px 6px; font-size:.8rem; }
    .type-badge { font-size:.7rem; padding:2px 6px; }
    .btn-sm { padding:6px 10px; font-size:.8rem; }
    .section-title { font-size:1rem; }
  }
</style>
</head>
<body>

<!-- LOCK SCREEN -->
<div class="lock-screen" id="lockScreen">
  <div class="lock-icon">ğŸ”</div>
  <h2>Mon Portefeuille</h2>
  <p>Tape le code d'accÃ¨s</p>
  <div class="lock-error" id="lockError"></div>
  <input type="password" id="lockInput" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" autocomplete="off">
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div style="font-size:3rem;">ğŸ“ˆ</div>
  <div class="loading-spinner"></div>
  <div style="color:var(--text2);font-size:.95rem;">Connexion en cours...</div>
</div>
<div class="container" id="appContainer" style="display:none;">
  <div class="top-bar">
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">ğŸŒ™</button>
    <button class="lock-btn" onclick="openSettingsModal()" title="ParamÃ¨tres des codes">ğŸ”’</button>
  </div>
  <div class="app-header">
    <div class="logo"><svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="32" cy="36" rx="22" ry="18" fill="#F8A5B8"/>
      <ellipse cx="32" cy="36" rx="22" ry="18" fill="url(#pgGrad)" opacity=".5"/>
      <ellipse cx="32" cy="36" rx="19" ry="15" fill="#FFB6C8"/>
      <ellipse cx="15" cy="33" rx="5" ry="6" fill="#F8A5B8"/>
      <ellipse cx="49" cy="33" rx="5" ry="6" fill="#F8A5B8"/>
      <ellipse cx="15" cy="33" rx="3.5" ry="4.5" fill="#FFB6C8"/>
      <ellipse cx="49" cy="33" rx="3.5" ry="4.5" fill="#FFB6C8"/>
      <circle cx="24" cy="29" r="2.5" fill="#2d3436"/>
      <circle cx="40" cy="29" r="2.5" fill="#2d3436"/>
      <circle cx="25" cy="28.2" r="1" fill="#fff"/>
      <circle cx="41" cy="28.2" r="1" fill="#fff"/>
      <ellipse cx="32" cy="38" rx="6" ry="4.5" fill="#E8889E"/>
      <circle cx="30" cy="37.5" r="1.2" fill="#D4758A"/>
      <circle cx="34" cy="37.5" r="1.2" fill="#D4758A"/>
      <path d="M20 48 L18 56 L22 56 L23 49" stroke="#E8889E" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      <path d="M44 48 L46 56 L42 56 L41 49" stroke="#E8889E" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      <path d="M52 34 Q56 32 55 38 Q54 42 51 40" stroke="#F8A5B8" stroke-width="2" fill="#F8A5B8"/>
      <rect x="27" y="17" rx="3" width="10" height="6" fill="#fdcb6e"/>
      <rect x="30.5" y="14" width="3" height="5" rx="1.5" fill="#f39c12"/>
      <circle cx="32" cy="19.5" r="1.5" fill="#f39c12"/>
      <defs><radialGradient id="pgGrad" cx="35%" cy="30%"><stop offset="0%" stop-color="#fff" stop-opacity=".3"/><stop offset="100%" stop-color="#F8A5B8" stop-opacity="0"/></radialGradient></defs>
    </svg></div>
    <h1>Mon Portefeuille</h1>
    <div class="tagline">Regarde ton argent grandir !</div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('invest')">ğŸ’° Investissements</div>
    <div class="tab" onclick="switchTab('patrimoine')">ğŸ  Patrimoine</div>
  </div>

  <!-- TAB INVESTISSEMENTS -->
  <div class="tab-content active" id="tab-invest">

    <div class="section-title"><span class="icon">ğŸ’°</span> Comment va ton portefeuille</div>
    <div class="stats">
      <div class="stat-card"><div class="emoji">ğŸ¦</div><div class="label">Tu as investi</div><div class="value accent" id="totalInvested">0,00 â‚¬</div></div>
      <div class="stat-card"><div class="emoji">ğŸ’</div><div class="label">Ca vaut maintenant</div><div class="value accent2" id="currentValue">0,00 â‚¬</div></div>
      <div class="stat-card"><div class="emoji">ğŸ‰</div><div class="label">Tu as gagnÃ©</div><div class="value green" id="totalGain">+0,00 â‚¬</div></div>
      <div class="stat-card"><div class="emoji">ğŸ“Š</div><div class="label">Rendement</div><div class="value gold" id="totalReturn">0,00%</div></div>
    </div>
    <div class="earnings-row">
      <div class="stat-card earnings-card"><div class="emoji">âš¡</div><div class="label">Tu gagnes par jour</div><div class="value green" id="earningsPerDay">+0,00 â‚¬</div><div class="earnings-sub" id="earningsPerDaySub"></div></div>
      <div class="stat-card earnings-card"><div class="emoji">ğŸš€</div><div class="label">Tu gagnes par mois</div><div class="value green" id="earningsPerMonth">+0,00 â‚¬</div><div class="earnings-sub" id="earningsPerMonthSub"></div></div>
    </div>

    <div class="card pending" id="pendingSection" style="display:none;">
      <div class="section-title"><span class="icon">â³</span> En attente de validation <span class="pending-count" id="pendingCount">0</span></div>
      <p class="form-hint">Hugo doit valider ces opÃ©rations avec son code secret avant qu'elles comptent.</p>
      <div id="pendingContainer"></div>
    </div>

    <div class="card">
      <div class="section-title"><span class="icon">â•</span> Investir de l'argent</div>
      <p class="form-hint">Tu veux investir ? Choisis la date et le montant, puis clique sur le bouton. Hugo devra valider ensuite.</p>
      <div class="form-row">
        <input type="hidden" id="type" value="invest">
        <div class="form-group"><label>ğŸ“… Date</label><input type="date" id="date"></div>
        <div class="form-group"><label>ğŸ’¶ Combien tu investis (â‚¬)</label><input type="number" id="amount" placeholder="Ex: 50" min="0" step="0.01"></div>
        <button class="btn btn-primary" onclick="addOperation()">ğŸš€ Investir !</button>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span class="icon">ğŸ“ˆ</span> L'Ã©volution de ton argent</div>
      <p class="form-hint" style="margin-bottom:10px;">La courbe en bleu c'est ce que ton argent vaut vraiment. La ligne violette c'est ce que tu as mis au total.</p>
      <div class="chart-wrapper"><canvas id="chart"></canvas></div>
    </div>

    <div class="admin-bar">
      <div><button class="btn-ghost danger" onclick="askPin('clearAll')">ğŸ—‘ Tout effacer</button></div>
    </div>

    <div class="card">
      <div class="section-title"><span class="icon">ğŸ“‹</span> Tes investissements</div>
      <div id="tableContainer"></div>
    </div>

    <hr class="sep">
    <div class="app-header" style="margin-bottom:20px;">
      <div class="logo">ğŸ”®</div>
      <h1 style="font-size:1.35rem;">Et si j'investissais pendant longtemps ?</h1>
      <div class="tagline">DÃ©couvre combien ton argent peut devenir en investissant rÃ©guliÃ¨rement</div>
    </div>
    <div class="card">
      <div class="section-title"><span class="icon">ğŸ®</span> Choisis tes paramÃ¨tres</div>
      <div class="form-row">
        <div class="form-group"><label>ğŸ’° Investissement de dÃ©part (â‚¬)</label><input type="number" id="simInit" placeholder="Ex: 1000" min="0" step="1" value="1000"></div>
        <div class="form-group"><label>ğŸ“… Chaque mois tu rajoutes (â‚¬)</label><input type="number" id="simMonthly" placeholder="Ex: 100" min="0" step="1" value="300"></div>
        <div class="form-group"><label>â° Pendant combien d'annÃ©es</label><input type="number" id="simYears" placeholder="Ex: 10" min="1" max="50" step="1" value="20"></div>
        <div class="form-group">
          <label>ğŸ“Š Rendement par an (%)</label>
          <div style="display:flex;align-items:center;gap:6px;">
            <button class="btn-pm" onclick="adjRate(-1)">âˆ’</button>
            <input type="number" id="simRate" min="0" max="50" step="0.5" value="10" style="text-align:center;flex:1;">
            <button class="btn-pm" onclick="adjRate(1)">+</button>
          </div>
        </div>
        <button class="btn btn-primary" onclick="runSim()">ğŸš€ Simuler !</button>
      </div>
    </div>
    <div class="stats" id="simStats" style="display:none;">
      <div class="stat-card"><div class="emoji">ğŸ¦</div><div class="label">Tu auras investi au total</div><div class="value accent" id="simTotalInvested">-</div></div>
      <div class="stat-card"><div class="emoji">ğŸ’</div><div class="label">Ca vaudra</div><div class="value accent2" id="simFinalValue">-</div></div>
      <div class="stat-card"><div class="emoji">ğŸ‰</div><div class="label">IntÃ©rÃªts gagnÃ©s</div><div class="value green" id="simInterest">-</div></div>
      <div class="stat-card"><div class="emoji">ğŸ“Š</div><div class="label">Rendement total</div><div class="value gold" id="simReturn">-</div></div>
    </div>
    <div class="earnings-row" id="simEarningsRow" style="display:none;">
      <div class="stat-card earnings-card"><div class="emoji">âš¡</div><div class="label">Tu gagneras par jour</div><div class="value green" id="simEarningsPerDay">+0,00 â‚¬</div><div class="earnings-sub" id="simEarningsPerDaySub"></div></div>
      <div class="stat-card earnings-card"><div class="emoji">ğŸš€</div><div class="label">Tu gagneras par mois</div><div class="value green" id="simEarningsPerMonth">+0,00 â‚¬</div><div class="earnings-sub" id="simEarningsPerMonthSub"></div></div>
    </div>
    <div class="card" id="simChartCard" style="display:none;">
      <div class="section-title"><span class="icon">ğŸ“ˆ</span> Ton argent dans <span id="simChartTitle">10</span> ans</div>
      <div class="chart-wrapper"><canvas id="simChart"></canvas></div>
    </div>
  </div>

  <!-- TAB PATRIMOINE -->
  <div class="tab-content" id="tab-patrimoine">

    <div class="stats">
      <div class="stat-card big">
        <div class="emoji">ğŸ‘‘</div>
        <div class="label">Ton patrimoine total</div>
        <div class="value accent2" id="patrimoineTotal">0,00 â‚¬</div>
        <div style="display:flex; justify-content:center; gap:24px; margin-top:10px; font-size:.78rem; color:var(--text2);">
          <span>ğŸ’° Investissements : <strong id="patrimoineInvest" style="color:var(--accent);">0,00 â‚¬</strong></span>
          <span>ğŸ  Biens : <strong id="patrimoineAssets" style="color:var(--gold);">0,00 â‚¬</strong></span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span class="icon">â•</span> Ajouter un bien</div>
      <p class="form-hint">Ajoute tout ce qui a de la valeur : argent liquide, moto, tÃ©lÃ©phone, console... Tu peux modifier la valeur quand tu veux.</p>
      <div class="form-row">
        <div class="form-group">
          <label>ğŸ· CatÃ©gorie</label>
          <select id="assetCat">
            <option value="ğŸ’µ">ğŸ’µ Argent liquide</option>
            <option value="ğŸ¦">ğŸ¦ Compte bancaire bloquÃ©</option>
            <option value="ğŸï¸">ğŸï¸ Moto / VÃ©hicule</option>
            <option value="ğŸ“±">ğŸ“± Tech (tel, console...)</option>
            <option value="ğŸ‘Ÿ">ğŸ‘Ÿ VÃªtements / Sneakers</option>
            <option value="ğŸ¸">ğŸ¸ Loisirs / Collection</option>
            <option value="ğŸ’°">ğŸ’° Autre</option>
          </select>
        </div>
        <div class="form-group"><label>âœï¸ Nom</label><input type="text" id="assetName" placeholder="Ex: Ma moto cross"></div>
        <div class="form-group"><label>ğŸ’¶ Valeur (â‚¬)</label><input type="number" id="assetValue" placeholder="Ex: 500" min="0" step="1"></div>
        <button class="btn btn-primary" onclick="addAsset()">â• Ajouter</button>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span class="icon">ğŸ“ˆ</span> L'Ã©volution de ton patrimoine</div>
      <p class="form-hint" style="margin-bottom:10px;">La courbe montre comment ton patrimoine total (investissements + biens) Ã©volue dans le temps.</p>
      <div class="chart-wrapper"><canvas id="patrimoineChart"></canvas></div>
    </div>

    <div class="card">
      <div class="section-title"><span class="icon">ğŸ </span> Tes biens</div>
      <div id="assetsContainer"></div>
    </div>
  </div>

  <div class="footer">Ton argent grossit de 10% par an grÃ¢ce aux intÃ©rÃªts composÃ©s ğŸ§ </div>
</div>

<!-- PIN Modal -->
<div class="modal-overlay" id="pinModal">
  <div class="modal">
    <div class="modal-icon">ğŸ”’</div>
    <h3 id="pinTitle">Code secret</h3>
    <p id="pinSubtitle">Tape le code secret de Hugo</p>
    <div class="modal-error" id="pinError"></div>
    <input type="password" id="pinInput" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" autocomplete="off">
    <div class="modal-btns">
      <button class="btn btn-red btn-sm" onclick="closePin()">Annuler</button>
      <button class="btn btn-green btn-sm" onclick="submitPin()">OK</button>
    </div>
  </div>
</div>

<!-- Setup PIN Modal -->
<div class="modal-overlay" id="setupModal">
  <div class="modal">
    <div class="modal-icon">ğŸ”‘</div>
    <h3>Bienvenue !</h3>
    <p>Hugo, choisis un code secret (4 chiffres). Tu en auras besoin pour valider les investissements.</p>
    <div class="modal-error" id="setupError"></div>
    <input type="password" id="setupPin" maxlength="4" placeholder="Ton code" inputmode="numeric" autocomplete="off">
    <div style="height:10px;"></div>
    <input type="password" id="setupPinConfirm" maxlength="4" placeholder="RÃ©pÃ¨te le code" inputmode="numeric" autocomplete="off">
    <div style="height:16px;"></div>
    <button class="btn btn-primary" onclick="setupPinSubmit()" style="width:100%;">âœ… C'est parti !</button>
  </div>
</div>

<!-- Edit Asset Modal -->
<div class="modal-overlay" id="editAssetModal">
  <div class="modal">
    <div class="modal-icon">âœï¸</div>
    <h3>Ajouter / modifier une valeur</h3>
    <p id="editAssetName">-</p>
    <label style="font-size:.82rem;color:var(--text2);display:block;margin-bottom:4px;text-align:left;">ğŸ“… Ã€ quelle date ?</label>
    <input type="date" id="editAssetDate" style="margin-bottom:12px;">
    <label style="font-size:.82rem;color:var(--text2);display:block;margin-bottom:4px;text-align:left;">ğŸ’¶ Valeur Ã  cette date (â‚¬)</label>
    <input type="number" id="editAssetValue" placeholder="Nouvelle valeur" min="0" step="1" inputmode="numeric">
    <div class="modal-btns">
      <button class="btn btn-red btn-sm" onclick="closeEditAsset()">Annuler</button>
      <button class="btn btn-green btn-sm" onclick="saveEditAsset()">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-icon">ğŸ”’</div>
    <h3>ParamÃ¨tres</h3>
    <!-- Step 1: Enter admin code -->
    <div id="settingsStep1">
      <p>Entre le code admin</p>
      <div class="modal-error" id="settingsError1"></div>
      <div class="pw-wrap"><input type="password" id="settingsAdminPin" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" autocomplete="off"><button type="button" class="pw-eye" onclick="togglePw(this)">ğŸ‘</button></div>
      <button class="btn btn-red btn-sm" onclick="closeSettings()" style="width:100%;">Annuler</button>
    </div>
    <!-- Step 2: Change codes -->
    <div id="settingsStep2" style="display:none;">
      <p>Modifie ce que tu veux, laisse vide pour ne pas changer.</p>
      <div class="modal-error" id="settingsError2"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <label style="font-size:.88rem;color:var(--text);">ğŸ” Code de connexion</label>
        <label class="toggle-switch"><input type="checkbox" id="settingsLockToggle" onchange="toggleLockPreview()"><span class="toggle-slider"></span></label>
      </div>
      <div id="settingsLockFields">
        <div class="pw-wrap"><input type="password" id="settingsNewAccessCode" maxlength="4" placeholder="Nouveau code (4 chiffres)" inputmode="numeric" autocomplete="off"><button type="button" class="pw-eye" onclick="togglePw(this)">ğŸ‘</button></div>
      </div>
      <div style="height:8px;border-top:1px solid var(--border);margin:4px 0 12px;"></div>
      <label style="font-size:.82rem;color:var(--text2);display:block;margin-bottom:4px;text-align:left;">ğŸ”‘ Nouveau code admin (4 chiffres)</label>
      <div class="pw-wrap"><input type="password" id="settingsNewPin" maxlength="4" placeholder="Laisser vide" inputmode="numeric" autocomplete="off"><button type="button" class="pw-eye" onclick="togglePw(this)">ğŸ‘</button></div>
      <div class="modal-btns">
        <button class="btn btn-red btn-sm" onclick="closeSettings()">Annuler</button>
        <button class="btn btn-green btn-sm" onclick="settingsSave()">ğŸ’¾ Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- THEME ---
function toggleTheme(){
  const curr=document.documentElement.getAttribute('data-theme')||'dark';
  const next=curr==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',next);
  document.getElementById('themeToggle').textContent=next==='dark'?'ğŸŒ™':'â˜€ï¸';
  localStorage.setItem('theme',next);
}
(function(){
  const saved=localStorage.getItem('theme')||'dark';
  document.documentElement.setAttribute('data-theme',saved);
})();
document.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('theme')||'dark';
  document.getElementById('themeToggle').textContent=saved==='dark'?'ğŸŒ™':'â˜€ï¸';
});

// --- LOCK SCREEN ---
let accessCode='0000'; // default, will be overridden by Firebase
document.getElementById('lockInput').addEventListener('input',function(){
  const v=this.value;
  document.getElementById('lockError').textContent='';
  if(v.length===4){
    if(v===accessCode){
      document.getElementById('lockScreen').classList.add('hidden');
      document.getElementById('appContainer').style.display='';
      sessionStorage.setItem('unlocked','1');
    } else {
      document.getElementById('lockError').textContent='Mauvais code !';
      this.value=''; this.focus();
    }
  }
});
// Check lock: skip if already unlocked OR if lock is disabled (cached locally for instant check)
if(sessionStorage.getItem('unlocked')==='1' || localStorage.getItem('lockEnabled')==='false'){
  document.getElementById('lockScreen').classList.add('hidden');
  document.addEventListener('DOMContentLoaded',()=>{ document.getElementById('appContainer').style.display=''; });
} else {
  document.addEventListener('DOMContentLoaded',()=>{ document.getElementById('lockInput').focus(); });
}

// --- PASSWORD TOGGLE ---
function togglePw(btn){
  const input=btn.previousElementSibling;
  if(input.type==='password'){input.type='text';btn.textContent='ğŸ™ˆ';btn.classList.add('showing');}
  else{input.type='password';btn.textContent='ğŸ‘';btn.classList.remove('showing');}
}

// --- SETTINGS MODAL ---
let lockEnabled=true; // default, overridden by Firebase
function openSettingsModal(){
  document.getElementById('settingsError1').textContent='';
  document.getElementById('settingsAdminPin').value='';
  document.getElementById('settingsStep1').style.display='';
  document.getElementById('settingsStep2').style.display='none';
  document.getElementById('settingsModal').classList.add('active');
  setTimeout(()=>document.getElementById('settingsAdminPin').focus(),100);
}
function closeSettings(){
  document.getElementById('settingsModal').classList.remove('active');
}
document.getElementById('settingsAdminPin').addEventListener('input',function(){
  const v=this.value.trim();
  const err=document.getElementById('settingsError1');
  err.textContent='';
  if(v.length>=4){
    if(v===getPin()){
      document.getElementById('settingsStep1').style.display='none';
      document.getElementById('settingsStep2').style.display='';
      document.getElementById('settingsError2').textContent='';
      document.getElementById('settingsNewAccessCode').value='';
      document.getElementById('settingsNewPin').value='';
      document.getElementById('settingsLockToggle').checked=lockEnabled;
      toggleLockPreview();
    } else {
      err.textContent='Mauvais code !';
      this.value=''; this.focus();
    }
  }
});
function toggleLockPreview(){
  const on=document.getElementById('settingsLockToggle').checked;
  document.getElementById('settingsLockFields').style.display=on?'':'none';
}
function settingsSave(){
  const err=document.getElementById('settingsError2');
  err.textContent='';
  const newLockEnabled=document.getElementById('settingsLockToggle').checked;
  const newAccess=document.getElementById('settingsNewAccessCode').value.trim();
  const newPin=document.getElementById('settingsNewPin').value.trim();
  if(newAccess&&!/^\d{4}$/.test(newAccess)){err.textContent='Le code connexion doit faire 4 chiffres.';return;}
  if(newPin&&!/^\d{4}$/.test(newPin)){err.textContent='Le code admin doit faire 4 chiffres.';return;}
  let changed=false;
  if(newLockEnabled!==lockEnabled){ lockEnabled=newLockEnabled; db.ref('lockEnabled').set(lockEnabled); changed=true; }
  if(newAccess){ accessCode=newAccess; db.ref('accessCode').set(newAccess); changed=true; }
  if(newPin){ setPin(newPin); changed=true; }
  if(!changed){err.textContent='Rien Ã  changer !';return;}
  closeSettings();
  alert('âœ… ParamÃ¨tres mis Ã  jour !');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyAmfQjTfM--hU7rQ2D4rlq0otV3zCZLHxE",
  authDomain: "portefeuille-d330f.firebaseapp.com",
  databaseURL: "https://portefeuille-d330f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "portefeuille-d330f",
  storageBucket: "portefeuille-d330f.firebasestorage.app",
  messagingSenderId: "1080692026103",
  appId: "1:1080692026103:web:dcbc459c6c1c61a81181f2"
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Load access code & lock setting from Firebase
db.ref('accessCode').on('value', s => { const v=s.val(); if(v) accessCode=v; });
db.ref('lockEnabled').on('value', s => {
  const v=s.val();
  lockEnabled=(v===null)?true:v;
  localStorage.setItem('lockEnabled',String(lockEnabled));
  if(!lockEnabled){
    document.getElementById('lockScreen').classList.add('hidden');
    document.getElementById('appContainer').style.display='';
  }
});

const ANNUAL_RATE = 0.10;
const DAILY_RATE = Math.pow(1 + ANNUAL_RATE, 1/365) - 1;

let operations = [];
let assets = [];
let patrimoineHistory = [];
let cachedPin = null;
let pendingAction = null;
let dataReady = false, pinReady = false, assetsReady = false, histReady = false;
let appInitialized = false;
let editingAssetId = null;

// --- TABS ---
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', (tab==='invest'?0:1)===i));
  document.getElementById('tab-invest').classList.toggle('active', tab==='invest');
  document.getElementById('tab-patrimoine').classList.toggle('active', tab==='patrimoine');
  if (tab==='patrimoine') renderPatrimoine();
}

// --- CONNECTION ---
db.ref('.info/connected').on('value', snap => {});

// --- FIREBASE LISTENERS ---
db.ref('pin').on('value', s => { cachedPin = s.val(); pinReady=true; tryInit(); });
db.ref('operations').on('value', s => {
  const d=s.val(); operations=d?Object.values(d):[]; operations.sort((a,b)=>new Date(a.date)-new Date(b.date));
  dataReady=true; tryInit(); if(appInitialized) render();
});
db.ref('assets').on('value', s => {
  const d=s.val(); assets=d?Object.values(d):[]; assetsReady=true; tryInit(); if(appInitialized) renderPatrimoine();
});
db.ref('patrimoineHistory').on('value', s => {
  const d=s.val(); patrimoineHistory=d?Object.values(d):[]; patrimoineHistory.sort((a,b)=>new Date(a.date)-new Date(b.date));
  histReady=true; tryInit(); if(appInitialized) renderPatrimoineChart();
});

function tryInit() { if(pinReady && dataReady && assetsReady && histReady && !appInitialized) initApp(); }
function initApp() {
  document.getElementById('loadingOverlay').classList.add('hidden');
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('date').value=today;
  appInitialized = true;
  render(); renderPatrimoine(); checkFirstRun(); runSim();
}
setTimeout(() => {
  if (!appInitialized) { pinReady=dataReady=assetsReady=histReady=true; initApp(); }
}, 5000);

// --- PIN ---
function getPin() { return cachedPin; }
function setPin(pin) { cachedPin=pin; db.ref('pin').set(pin); }
function checkFirstRun() { if(!getPin()) document.getElementById('setupModal').classList.add('active'); }
function setupPinSubmit() {
  const pin=document.getElementById('setupPin').value.trim(), confirm2=document.getElementById('setupPinConfirm').value.trim(), err=document.getElementById('setupError');
  if(!/^\d{4}$/.test(pin)){err.textContent='Le code doit contenir 4 chiffres.';return;}
  if(pin!==confirm2){err.textContent='Les deux codes ne sont pas identiques !';return;}
  setPin(pin); document.getElementById('setupModal').classList.remove('active');
}
function askPin(action, data) {
  pendingAction={action,data}; document.getElementById('pinError').textContent=''; document.getElementById('pinInput').value='';
  document.getElementById('pinModal').classList.add('active');
  setTimeout(()=>document.getElementById('pinInput').focus(),100);
  const t={approve:'âœ… Valider',reject:'âŒ Rejeter',delete:'ğŸ—‘ Supprimer',clearAll:'ğŸ—‘ Tout effacer',changePin:'ğŸ”‘ Changer le code',deleteAsset:'ğŸ—‘ Supprimer le bien'};
  document.getElementById('pinTitle').textContent=t[action]||'Validation';
  document.getElementById('pinSubtitle').textContent='Tape le code secret de Hugo';
}
function closePin() { document.getElementById('pinModal').classList.remove('active'); pendingAction=null; }
function submitPin() {
  const pin=document.getElementById('pinInput').value.trim();
  if(pin!==getPin()){document.getElementById('pinError').textContent='Mauvais code ! RÃ©essaye.';document.getElementById('pinInput').value='';document.getElementById('pinInput').focus();return;}
  const saved=pendingAction; closePin(); if(!saved)return;
  const{action,data}=saved;
  switch(action){
    case 'approve':approveOp(data);break; case 'reject':rejectOp(data);break; case 'delete':deleteOp(data);break;
    case 'clearAll':clearAllConfirmed();break; case 'deleteAsset':deleteAsset(data);break;
    case 'changePin':document.getElementById('setupModal').classList.add('active');break;
  }
}
document.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    if(document.getElementById('pinModal').classList.contains('active'))submitPin();
    if(document.getElementById('setupModal').classList.contains('active'))setupPinSubmit();
    if(document.getElementById('editAssetModal').classList.contains('active'))saveEditAsset();
    if(document.getElementById('settingsModal').classList.contains('active')&&document.getElementById('settingsStep2').style.display!=='none')settingsSave();
  }
});

// --- DATA ---
function saveOps() { const o={}; for(const op of operations) o[op.id]=op; db.ref('operations').set(o); }
function saveAssets() { const o={}; for(const a of assets) o[a.id]=a; db.ref('assets').set(o); }
function savePatrimoineSnapshot() {
  const portfolioVal = calcPortfolioAt(new Date()).currentValue;
  const assetsVal = assets.reduce((s,a)=>s+a.value,0);
  const entry = { date:new Date().toISOString(), portfolioValue:Math.round(portfolioVal*100)/100, assetsValue:assetsVal, total:Math.round((portfolioVal+assetsVal)*100)/100, id:Date.now() };
  patrimoineHistory.push(entry);
  const o={}; for(const h of patrimoineHistory) o[h.id]=h; db.ref('patrimoineHistory').set(o);
}
function getApproved() { return operations.filter(o=>o.status==='approved'); }
function getPending() { return operations.filter(o=>o.status==='pending'); }

// --- CALCULATIONS ---
function calcPortfolioAt(targetDate) {
  const target=targetDate instanceof Date?targetDate:new Date(targetDate);
  let totalInvested=0,totalWithdrawn=0,lots=[];
  const sorted=[...getApproved()].sort((a,b)=>new Date(a.date)-new Date(b.date));
  for(const op of sorted){
    const opDate=new Date(op.date); if(opDate>target)break;
    if(op.type==='invest'){lots.push({amount:op.amount,date:op.date});totalInvested+=op.amount;}
    else if(op.type==='retrait'){
      totalWithdrawn+=op.amount; let totalVal=0;
      for(const lot of lots) totalVal+=calcLotValue(lot.amount,lot.date,opDate);
      if(totalVal>0){const ratio=op.amount/totalVal;for(const lot of lots){const lv=calcLotValue(lot.amount,lot.date,opDate);lot.amount=lv-lv*ratio;lot.date=op.date;}}
    }
  }
  let currentValue=0; for(const lot of lots){if(lot.amount>0)currentValue+=calcLotValue(lot.amount,lot.date,target);}
  return {totalInvested,totalWithdrawn,currentValue};
}
function calcLotValue(amount,dateStr,targetDate){
  const d=new Date(dateStr),t=targetDate instanceof Date?targetDate:new Date(targetDate);
  return amount*Math.pow(1+DAILY_RATE,Math.max(0,(t-d)/(1000*60*60*24)));
}
function fmt(n){return n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' â‚¬';}
function fmtDate(d){const m=['jan','fÃ©v','mar','avr','mai','jun','jul','aoÃ»','sep','oct','nov','dÃ©c'];return d.getDate()+' '+m[d.getMonth()]+' '+d.getFullYear();}
function durationSince(dateStr){
  const days=Math.floor((new Date()-new Date(dateStr))/(1000*60*60*24));
  if(days<1)return"aujourd'hui";if(days===1)return"hier";if(days<30)return'il y a '+days+' j';
  const mo=Math.floor(days/30.44);if(mo<12)return'il y a '+mo+' mois';
  const y=Math.floor(mo/12),r=mo%12;return r===0?'il y a '+y+' an'+(y>1?'s':''):'il y a '+y+'a '+r+'m';
}

// --- OPERATIONS ---
function addOperation(){
  const type=document.getElementById('type').value,date=document.getElementById('date').value,amount=parseFloat(document.getElementById('amount').value);
  if(!date||isNaN(amount)||amount<=0){alert('Mets une date et un montant !');return;}
  operations.push({type,date,amount,id:Date.now(),status:'pending',createdAt:new Date().toISOString()});
  operations.sort((a,b)=>new Date(a.date)-new Date(b.date)); saveOps();
  document.getElementById('amount').value='';
  alert('ğŸ‘ C\'est envoyÃ© ! Hugo doit maintenant valider.');
}
function approveOp(id){
  const op=operations.find(o=>o.id===id); if(!op)return;
  if(op.type==='retrait'){const p=calcPortfolioAt(new Date(op.date));if(op.amount>p.currentValue+0.01){alert('Le retrait ('+fmt(op.amount)+') dÃ©passe le portefeuille ('+fmt(p.currentValue)+').');return;}}
  op.status='approved';op.approvedAt=new Date().toISOString(); saveOps(); savePatrimoineSnapshot();
}
function rejectOp(id){operations=operations.filter(o=>o.id!==id);saveOps();}
function deleteOp(id){operations=operations.filter(o=>o.id!==id);saveOps();savePatrimoineSnapshot();}
function clearAllConfirmed(){if(confirm('Tu es sÃ»r ? Tout sera effacÃ© pour toujours !')){operations=[];saveOps();savePatrimoineSnapshot();}}

// --- ASSETS ---
function addAsset(){
  const cat=document.getElementById('assetCat').value, name=document.getElementById('assetName').value.trim(), value=parseFloat(document.getElementById('assetValue').value);
  if(!name||isNaN(value)||value<0){alert('Mets un nom et une valeur !');return;}
  const now=new Date().toISOString(), today=now.split('T')[0];
  const entry={date:today, value, id:Date.now()};
  assets.push({id:Date.now()+1, cat, name, value, createdAt:now, updatedAt:now, valueHistory:[entry]});
  saveAssets(); savePatrimoineSnapshot();
  document.getElementById('assetName').value=''; document.getElementById('assetValue').value='';
}
function openEditAsset(id){
  const a=assets.find(x=>x.id===id); if(!a)return;
  editingAssetId=id;
  document.getElementById('editAssetName').textContent=a.cat+' '+a.name;
  document.getElementById('editAssetDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('editAssetValue').value='';
  document.getElementById('editAssetModal').classList.add('active');
  setTimeout(()=>document.getElementById('editAssetValue').focus(),100);
}
function closeEditAsset(){document.getElementById('editAssetModal').classList.remove('active');editingAssetId=null;}
function saveEditAsset(){
  const v=parseFloat(document.getElementById('editAssetValue').value);
  const d=document.getElementById('editAssetDate').value;
  if(!d){alert('Choisis une date !');return;}
  if(isNaN(v)||v<0){alert('Mets une valeur valide !');return;}
  const a=assets.find(x=>x.id===editingAssetId); if(!a)return;
  if(!a.valueHistory) a.valueHistory=[];
  a.valueHistory=a.valueHistory.filter(h=>h.date!==d);
  a.valueHistory.push({date:d, value:v, id:Date.now()});
  a.valueHistory.sort((x,y)=>x.date.localeCompare(y.date));
  const latest=a.valueHistory[a.valueHistory.length-1];
  a.value=latest.value; a.updatedAt=new Date().toISOString();
  saveAssets(); savePatrimoineSnapshot(); closeEditAsset();
}
function deleteHistoryEntry(assetId, entryId){
  const a=assets.find(x=>x.id===assetId); if(!a||!a.valueHistory)return;
  if(a.valueHistory.length<=1){alert('Tu ne peux pas supprimer la derniÃ¨re valeur !');return;}
  a.valueHistory=a.valueHistory.filter(h=>h.id!==entryId);
  a.valueHistory.sort((x,y)=>x.date.localeCompare(y.date));
  const latest=a.valueHistory[a.valueHistory.length-1];
  a.value=latest.value; a.updatedAt=new Date().toISOString();
  saveAssets(); savePatrimoineSnapshot();
}
function deleteAsset(id){assets=assets.filter(a=>a.id!==id);saveAssets();savePatrimoineSnapshot();}
function getAssetValueAt(asset, date){
  if(!asset.valueHistory||!asset.valueHistory.length) return asset.value;
  const ds=typeof date==='string'?date:date.toISOString().split('T')[0];
  let val=0;
  for(const h of asset.valueHistory){
    if(h.date<=ds) val=h.value; else break;
  }
  return val;
}
let openHistoryIds=new Set();

// --- RENDER INVEST ---
function updateStats(){
  const{totalInvested,totalWithdrawn,currentValue}=calcPortfolioAt(new Date());
  const net=totalInvested-totalWithdrawn,gain=currentValue-net,pct=net>0?(gain/net)*100:0;
  document.getElementById('totalInvested').textContent=fmt(totalInvested);
  document.getElementById('currentValue').textContent=fmt(currentValue);
  document.getElementById('totalGain').textContent=(gain>=0?'+':'')+fmt(gain);
  document.getElementById('totalReturn').textContent=pct.toFixed(2)+'%';
  // Gains par jour et par mois
  const dailyGain=currentValue*DAILY_RATE;
  const monthlyGain=currentValue*(Math.pow(1+DAILY_RATE,30)-1);
  const perDayEl=document.getElementById('earningsPerDay');
  const perMonthEl=document.getElementById('earningsPerMonth');
  perDayEl.textContent='+'+fmt(dailyGain);
  perMonthEl.textContent='+'+fmt(monthlyGain);
  // Petite phrase fun en dessous
  const daySubEl=document.getElementById('earningsPerDaySub');
  const monthSubEl=document.getElementById('earningsPerMonthSub');
  if(dailyGain>=1) daySubEl.textContent='ğŸ’ª MÃªme en dormant !';
  else if(dailyGain>0) daySubEl.textContent='ğŸŒ± Ã‡a pousse doucement...';
  else daySubEl.textContent='';
  if(monthlyGain>=50) monthSubEl.textContent='ğŸ”¥ Pas mal du tout !';
  else if(monthlyGain>=10) monthSubEl.textContent='ğŸ“ˆ Ã‡a monte bien !';
  else if(monthlyGain>0) monthSubEl.textContent='ğŸŒ± Continue comme Ã§a !';
  else monthSubEl.textContent='';
  // Animation si gains > 0
  document.querySelectorAll('.earnings-card').forEach(c=>{
    if(currentValue>0) c.classList.add('active'); else c.classList.remove('active');
  });
}
function renderPending(){
  const pending=getPending(),section=document.getElementById('pendingSection'),container=document.getElementById('pendingContainer');
  document.getElementById('pendingCount').textContent=pending.length;
  if(!pending.length){section.style.display='none';return;} section.style.display='block';
  let h='<table><thead><tr><th>Type</th><th>Date</th><th>Montant</th><th>Actions</th></tr></thead><tbody>';
  for(const op of pending){
    const ds=new Date(op.date).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
    const tc=op.type==='invest'?'type-invest':'type-retrait',tl=op.type==='invest'?'Investissement':'Retrait';
    const sign=op.type==='invest'?'+':'-',ac=op.type==='invest'?'plus-value':'retrait-value';
    h+=`<tr><td><span class="type-badge ${tc}">${tl}</span></td><td>${ds}</td><td class="${ac}">${sign}${fmt(op.amount)}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap;"><button class="btn btn-green btn-sm" onclick="askPin('approve',${op.id})">âœ… OK</button><button class="btn btn-red btn-sm" onclick="askPin('reject',${op.id})">âŒ Non</button></td></tr>`;
  }
  container.innerHTML=h+'</tbody></table>';
}
function renderTable(){
  const container=document.getElementById('tableContainer'),approved=getApproved();
  if(!approved.length){container.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ«™</div>Aucun investissement pour le moment.<br>Ajoute ton premier investissement ci-dessus !</div>';return;}
  let h='<table><thead><tr><th>Type</th><th>Date</th><th>Depuis</th><th>Montant</th><th></th></tr></thead><tbody>';
  for(const op of approved){
    const ds=new Date(op.date).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
    const tc=op.type==='invest'?'type-invest':'type-retrait',tl=op.type==='invest'?'ğŸ“¥ Invest':'ğŸ“¤ Retrait';
    const sign=op.type==='invest'?'+':'-',ac=op.type==='invest'?'plus-value':'retrait-value';
    h+=`<tr><td><span class="type-badge ${tc}">${tl}</span></td><td>${ds}</td><td><span class="duration-info">${durationSince(op.date)}</span></td>
      <td class="${ac}">${sign}${fmt(op.amount)}</td><td><button class="btn-delete" onclick="askPin('delete',${op.id})">ğŸ—‘</button></td></tr>`;
  }
  container.innerHTML=h+'</tbody></table>';
}
let chartInstance=null;
function renderChart(){
  const approved=getApproved().filter(o=>o.type==='invest');
  if(!approved.length){if(chartInstance){chartInstance.destroy();chartInstance=null;}return;}
  const sorted=[...getApproved()].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const start=new Date(sorted[0].date),today=new Date();
  const labels=[],valueData=[],investedData=[],totalDays=(today-start)/(1000*60*60*24);
  const step=totalDays>730?14:totalDays>365?7:totalDays>90?3:1;
  for(let d=new Date(start);d<=today;d.setDate(d.getDate()+step)){
    const s=calcPortfolioAt(new Date(d)); labels.push(fmtDate(new Date(d)));
    valueData.push(Math.round(s.currentValue*100)/100); investedData.push(Math.round((s.totalInvested-s.totalWithdrawn)*100)/100);
  }
  const f=calcPortfolioAt(today); labels.push(fmtDate(today));
  valueData.push(Math.round(f.currentValue*100)/100); investedData.push(Math.round((f.totalInvested-f.totalWithdrawn)*100)/100);
  const ctx=document.getElementById('chart').getContext('2d');
  if(chartInstance)chartInstance.destroy();
  chartInstance=new Chart(ctx,{type:'line',data:{labels,datasets:[
    {label:'Valeur actuelle',data:valueData,borderColor:'#00cec9',backgroundColor:'rgba(0,206,201,.1)',fill:true,tension:.3,pointRadius:0,borderWidth:2},
    {label:'Ce que j\'ai investi',data:investedData,borderColor:'#6c5ce7',backgroundColor:'rgba(108,92,231,.05)',fill:true,tension:.3,pointRadius:0,borderWidth:2,borderDash:[5,5]}
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},
    plugins:{legend:{labels:{color:'#a0a4b8',usePointStyle:true,padding:20}},tooltip:{backgroundColor:'#1a1d2e',borderColor:'#2a2d3e',borderWidth:1,titleColor:'#dfe6e9',bodyColor:'#dfe6e9',callbacks:{label:c=>c.dataset.label+': '+fmt(c.parsed.y)}}},
    scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#a0a4b8',maxTicksLimit:10,maxRotation:45,minRotation:20}},y:{beginAtZero:true,grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#a0a4b8',callback:v=>v.toLocaleString('fr-FR')+' â‚¬'}}}}});
}

// --- RENDER PATRIMOINE ---
function renderPatrimoine(){
  const portfolioVal=calcPortfolioAt(new Date()).currentValue;
  const assetsVal=assets.reduce((s,a)=>s+a.value,0);
  document.getElementById('patrimoineTotal').textContent=fmt(portfolioVal+assetsVal);
  document.getElementById('patrimoineInvest').textContent=fmt(portfolioVal);
  document.getElementById('patrimoineAssets').textContent=fmt(assetsVal);
  renderAssetsList(); renderPatrimoineChart();
}
function renderAssetsList(){
  const container=document.getElementById('assetsContainer');
  if(!assets.length){container.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ </div>Aucun bien pour le moment.<br>Ajoute ton premier bien ci-dessus !</div>';return;}
  let h='';
  for(const a of assets){
    const dateStr=new Date(a.updatedAt||a.createdAt).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
    const histCount=(a.valueHistory||[]).length;
    const isOpen=openHistoryIds.has(a.id);
    h+=`<div class="asset-item">
      <div class="asset-icon">${a.cat}</div>
      <div class="asset-info"><div class="asset-name">${a.name}</div><div class="asset-date">Mis Ã  jour le ${dateStr}</div></div>
      <div class="asset-value">${fmt(a.value)}</div>
      <div class="asset-actions">
        <button class="btn-edit" onclick="openEditAsset(${a.id})" title="Ajouter une valeur">âœï¸</button>
        <button class="btn-delete" onclick="askPin('deleteAsset',${a.id})">ğŸ—‘</button>
      </div>
    </div>`;
    if(histCount>0){
      h+=`<div class="asset-history">
        <div class="asset-history-title" onclick="toggleHistory(${a.id})">${isOpen?'â–¼':'â–¶'} Historique des valeurs (${histCount})</div>`;
      if(isOpen){
        h+='<div>';
        for(const entry of (a.valueHistory||[])){
          const ed=new Date(entry.date+'T00:00:00').toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
          h+=`<div class="history-entry">
            <span class="he-date">${ed}</span>
            <span class="he-value">${fmt(entry.value)}</span>
            ${histCount>1?`<button class="he-del" onclick="deleteHistoryEntry(${a.id},${entry.id})">âœ•</button>`:''}
          </div>`;
        }
        h+='</div>';
      }
      h+='</div>';
    }
  }
  container.innerHTML=h;
}
function toggleHistory(assetId){
  if(openHistoryIds.has(assetId)) openHistoryIds.delete(assetId); else openHistoryIds.add(assetId);
  renderAssetsList();
}
let patrimoineChartInst=null;
function renderPatrimoineChart(){
  const dateSet=new Set();
  for(const a of assets){
    if(a.valueHistory) for(const h of a.valueHistory) dateSet.add(h.date);
  }
  for(const op of getApproved()) dateSet.add(op.date);
  const today=new Date().toISOString().split('T')[0];
  dateSet.add(today);
  if(dateSet.size<2 && assets.length===0 && getApproved().length===0){if(patrimoineChartInst){patrimoineChartInst.destroy();patrimoineChartInst=null;}return;}

  const dates=[...dateSet].sort();
  const first=new Date(dates[0]+'T00:00:00'), last=new Date(dates[dates.length-1]+'T00:00:00');
  const totalDays=(last-first)/(1000*60*60*24);
  const step=totalDays>730?14:totalDays>365?7:totalDays>90?3:1;
  for(let d=new Date(first);d<=last;d.setDate(d.getDate()+step)){
    dateSet.add(d.toISOString().split('T')[0]);
  }
  const allDates=[...dateSet].sort();

  const labels=[],totals=[],investVals=[],assetVals=[];
  for(const ds of allDates){
    const d=new Date(ds+'T00:00:00');
    const pv=calcPortfolioAt(d).currentValue;
    let av=0;
    for(const a of assets) av+=getAssetValueAt(a,ds);
    labels.push(fmtDate(d));
    investVals.push(Math.round(pv*100)/100);
    assetVals.push(Math.round(av*100)/100);
    totals.push(Math.round((pv+av)*100)/100);
  }

  const ctx=document.getElementById('patrimoineChart').getContext('2d');
  if(patrimoineChartInst)patrimoineChartInst.destroy();
  patrimoineChartInst=new Chart(ctx,{type:'line',data:{labels,datasets:[
    {label:'Patrimoine total',data:totals,borderColor:'#00cec9',backgroundColor:'rgba(0,206,201,.1)',fill:true,tension:.3,pointRadius:0,borderWidth:2},
    {label:'Investissements',data:investVals,borderColor:'#6c5ce7',backgroundColor:'rgba(108,92,231,.05)',fill:false,tension:.3,pointRadius:0,borderWidth:2,borderDash:[5,5]},
    {label:'Biens',data:assetVals,borderColor:'#fdcb6e',backgroundColor:'rgba(253,203,110,.05)',fill:false,tension:.3,pointRadius:0,borderWidth:2,borderDash:[3,3]}
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},
    plugins:{legend:{labels:{color:'#a0a4b8',usePointStyle:true,padding:20}},tooltip:{backgroundColor:'#1a1d2e',borderColor:'#2a2d3e',borderWidth:1,titleColor:'#dfe6e9',bodyColor:'#dfe6e9',callbacks:{label:c=>c.dataset.label+': '+fmt(c.parsed.y)}}},
    scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#a0a4b8',maxTicksLimit:10,maxRotation:45,minRotation:20}},y:{beginAtZero:true,grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#a0a4b8',callback:v=>v.toLocaleString('fr-FR')+' â‚¬'}}}}});
}

// --- SIMULATEUR ---
let simChartInstance=null;
function adjRate(delta){const el=document.getElementById('simRate');let v=parseFloat(el.value)||8;v=Math.round((v+delta)*10)/10;if(v<0)v=0;if(v>50)v=50;el.value=v;}
function runSim(){
  const init=parseFloat(document.getElementById('simInit').value)||0,monthly=parseFloat(document.getElementById('simMonthly').value)||0;
  const years=parseInt(document.getElementById('simYears').value)||1,annualRate=(parseFloat(document.getElementById('simRate').value)||8)/100;
  if(init<=0&&monthly<=0){alert('Mets au moins un montant !');return;}
  const monthlyRate=Math.pow(1+annualRate,1/12)-1,totalMonths=years*12;
  const labels=[],valueData=[],investedData=[]; let balance=init,totalInvested=init;
  labels.push('DÃ©but');valueData.push(Math.round(balance*100)/100);investedData.push(Math.round(totalInvested*100)/100);
  for(let m=1;m<=totalMonths;m++){balance=balance*(1+monthlyRate)+monthly;totalInvested+=monthly;labels.push(m%12===0?'An '+(m/12):'M'+m);valueData.push(Math.round(balance*100)/100);investedData.push(Math.round(totalInvested*100)/100);}
  const interest=balance-totalInvested,returnPct=totalInvested>0?(interest/totalInvested*100):0;
  document.getElementById('simStats').style.display='';document.getElementById('simChartCard').style.display='';document.getElementById('simEarningsRow').style.display='';
  document.getElementById('simTotalInvested').textContent=fmt(totalInvested);document.getElementById('simFinalValue').textContent=fmt(balance);
  document.getElementById('simInterest').textContent=fmt(interest);document.getElementById('simReturn').textContent=returnPct.toFixed(1)+' %';
  document.getElementById('simChartTitle').textContent=years;
  // Earnings per day/month from simulated final balance
  const simDailyRate=Math.pow(1+annualRate,1/365)-1;
  const simDailyGain=balance*simDailyRate;
  const simMonthlyGain=balance*(Math.pow(1+simDailyRate,30)-1);
  document.getElementById('simEarningsPerDay').textContent='+'+fmt(simDailyGain);
  document.getElementById('simEarningsPerMonth').textContent='+'+fmt(simMonthlyGain);
  const sdSub=document.getElementById('simEarningsPerDaySub'),smSub=document.getElementById('simEarningsPerMonthSub');
  if(simDailyGain>=10)sdSub.textContent='ğŸ¤‘ Machine Ã  billets !';
  else if(simDailyGain>=1)sdSub.textContent='ğŸ’ª MÃªme en dormant !';
  else if(simDailyGain>0)sdSub.textContent='ğŸŒ± Ã‡a pousse doucement...';
  else sdSub.textContent='';
  if(simMonthlyGain>=500)smSub.textContent='ğŸ† Un vrai salaire passif !';
  else if(simMonthlyGain>=50)smSub.textContent='ğŸ”¥ Pas mal du tout !';
  else if(simMonthlyGain>=10)smSub.textContent='ğŸ“ˆ Ã‡a monte bien !';
  else if(simMonthlyGain>0)smSub.textContent='ğŸŒ± Continue comme Ã§a !';
  else smSub.textContent='';
  document.querySelectorAll('#simEarningsRow .earnings-card').forEach(c=>{c.classList.remove('active');if(balance>0)setTimeout(()=>c.classList.add('active'),100);});
  const step2=Math.max(1,Math.floor(totalMonths/60));const fL=[],fV=[],fI=[];
  for(let i=0;i<labels.length;i++){if(i===0||i===labels.length-1||i%step2===0){fL.push(labels[i]);fV.push(valueData[i]);fI.push(investedData[i]);}}
  const ctx=document.getElementById('simChart').getContext('2d');
  if(simChartInstance)simChartInstance.destroy();
  simChartInstance=new Chart(ctx,{type:'line',data:{labels:fL,datasets:[
    {label:'Valeur actuelle',data:fV,borderColor:'#00cec9',backgroundColor:'rgba(0,206,201,.1)',fill:true,tension:.3,pointRadius:0,borderWidth:2},
    {label:'Ce que j\'ai investi',data:fI,borderColor:'#6c5ce7',backgroundColor:'rgba(108,92,231,.05)',fill:true,tension:.3,pointRadius:0,borderWidth:2,borderDash:[5,5]}
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},
    plugins:{legend:{labels:{color:'#a0a4b8',usePointStyle:true,padding:20}},tooltip:{backgroundColor:'#1a1d2e',borderColor:'#2a2d3e',borderWidth:1,titleColor:'#dfe6e9',bodyColor:'#dfe6e9',callbacks:{label:c=>c.dataset.label+': '+fmt(c.parsed.y)}}},
    scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#a0a4b8',maxTicksLimit:12,maxRotation:45,minRotation:20}},y:{beginAtZero:true,grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#a0a4b8',callback:v=>v.toLocaleString('fr-FR')+' â‚¬'}}}}});
}

function render(){updateStats();renderPending();renderTable();renderChart();}
</script>
</body>
</html>
